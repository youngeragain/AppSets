<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="xcj.app.userinfo.dao.mysql.UserDao">

    <select id="getUserUidByAccountAndPassword" resultType="java.lang.String">
        select uid from user_2022 where account=#{account} and `password`=#{password}
    </select>
    <select id="getUserByAccountAndPassword" resultType="xcj.app.userinfo.model.table.mysql.User">
        select id, account, password, sign_up_time, agree_to_the_agreement, can_multi_online, uid , salt, hash from user_2022 where account=#{account} and `password`=#{password}
    </select>
    <select id="getUserByAccount" resultType="xcj.app.userinfo.model.table.mysql.User">
        select id, account, password, sign_up_time, agree_to_the_agreement, can_multi_online, uid, salt, hash from user_2022 where account=#{account}
    </select>

    <select id="getUserByUid" resultType="xcj.app.userinfo.model.table.mysql.User">
        select id, account, password, sign_up_time, agree_to_the_agreement, can_multi_online, uid, salt, hash from user_2022 where uid=#{uid}
    </select>

    <insert id="addUser">
        insert into user_2022(account, `password`, sign_up_time, uid, salt, hash)
        value (#{account},#{password},current_timestamp(), #{uid}, #{salt}, #{hash});
        insert into user_info_2022(
        <if test="avatarUrl!=null">avatar_url ,</if>
        <if test="introduction!=null">introduction ,</if>
        <if test="tags!=null">tags ,</if>
        <if test="sex!=null">sex ,</if>
        <if test="age!=null">age ,</if>
        <if test="phone!=null">phone ,</if>
        <if test="email!=null">email ,</if>
        <if test="area!=null">area ,</if>
        <if test="address!=null">address ,</if>
        <if test="website!=null">website ,</if>
        uid,
        name )
        value(
        <if test="avatarUrl!=null">#{avatarUrl} ,</if>
        <if test="introduction!=null">#{introduction} ,</if>
        <if test="tags!=null">#{tags} ,</if>
        <if test="sex!=null">#{sex} ,</if>
        <if test="age!=null">#{age} ,</if>
        <if test="phone!=null">#{phone} ,</if>
        <if test="email!=null">#{email} ,</if>
        <if test="area!=null">#{area} ,</if>
        <if test="address!=null">#{address} ,</if>
        <if test="website!=null">#{website} </if>
        #{uid},
        #{name} )
    </insert>

    <select id="getUserInfoByUid" resultType="xcj.app.userinfo.model.res.UserInfoRes">
        select
            user_2022.agree_to_the_agreement,
            user_2022.uid,
            user_info_2022.`name`,
            user_info_2022.age,
            user_info_2022.sex,
            user_info_2022.email,
            user_info_2022.phone,
            user_info_2022.address,
            user_info_2022.avatar_url,
            user_info_2022.introduction,
            user_info_2022.company,
            user_info_2022.profession,
            user_info_2022.website
        from
            user_2022
        left join user_info_2022
        on user_info_2022.uid = user_2022.uid
        where user_2022.uid = #{uid}
    </select>

    <select id="getUserInfoList" resultType="xcj.app.userinfo.model.res.UserInfoRes">
        select
            user_2022.agree_to_the_agreement,
            user_2022.uid,
            user_info_2022.`name`,
            user_info_2022.age,
            user_info_2022.sex,
            user_info_2022.email,
            user_info_2022.phone,
            user_info_2022.address,
            user_info_2022.avatar_url,
            user_info_2022.introduction,
            user_info_2022.company,
            user_info_2022.profession,
            user_info_2022.website
        from
            user_2022
                left join user_info_2022
                          on user_info_2022.uid = user_2022.uid
        where user_2022.uid  in
        <foreach collection="uids" open="(" close=")" separator="," item="uid">
            #{uid}
        </foreach>
    </select>
    <update id="updateUser" parameterType="xcj.app.userinfo.model.table.mysql.User">
        update user_2022
        <trim prefix="set" suffixOverrides=",">
            <if test="password!=null">
                password=#{password},
            </if>
            <if test="signInTime!=null">
                sign_in_time=#{signInTime},
            </if>
            <if test="singInTimes!=null">
                sign_in_times=#{singInTimes},
            </if>
            <if test="signDeviceInfo!=null">
                sign_device_info=#{signDeviceInfo},
            </if>
            <if test="signInLocation!=null">
                sign_in_location=#{signInLocation},
            </if>
            <if test="signInIp!=null">
                sign_in_ip=#{signInIp},
            </if>
            <if test="agreeToTheAgreement!=null">
                agree_to_the_agreement=#{agreeToTheAgreement},
            </if>
        </trim>
        where uid = #{uid}
    </update>

    <update id="updateUserSaltHash" parameterType="xcj.app.userinfo.model.table.mysql.User">
        update user_2022
        set salt=#{salt}, hash=#{hash}
        where uid = #{uid}
    </update>

    <select id="findUserCountByUserIds">
        select count(1) from user_2022 where uid in
        <foreach collection="uids" open="(" close=")" separator="," item="uid">
            #{uid}
        </foreach>
    </select>
    <select id="isUserIdExist" resultType="java.lang.Boolean">
        select count(1)
        from user_2022
        where uid = #{uid};
    </select>


    <select id="searchUserByKeywords" resultType="xcj.app.userinfo.model.res.UserInfoRes">
        select
        user_2022.agree_to_the_agreement,
        user_2022.uid,
        user_info_2022.`name`,
        user_info_2022.age,
        user_info_2022.sex,
        user_info_2022.email,
        user_info_2022.phone,
        user_info_2022.address,
        user_info_2022.avatar_url,
        user_info_2022.introduction,
        user_info_2022.company,
        user_info_2022.profession,
        user_info_2022.website
        from
        user_2022
        left join user_info_2022
        on user_info_2022.uid = user_2022.uid
        where user_2022.account like "%"#{accountEncFromKeywords}"%" or user_info_2022.`name` like "%"#{keywords}"%"
    </select>


    <cache/>
</mapper>